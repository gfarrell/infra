---
version: '3'
services:

  nginx:
    build: ./nginx
    depends_on:
      - mailman-web
      - jenkins
    networks:
      - backend
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/www:/var/www
      - /etc/letsencrypt:/var/www-secure

  pg:
    image: postgres:11-alpine
    volumes:
      - db-data:/var/lib/postgresql/data
    networks:
      - backend
    environment:
      POSTGRES_DB: mailman
      POSTGRES_USER: "${PG_USER}"
      POSTGRES_PASSWORD: "${PG_PASS}"

  mailman-core:
    image: quay.io/maxking/mailman-core:0.2
    volumes:
      - mm-core-data:/opt/mailman
    depends_on:
      - pg
      - exim
    networks:
      - backend
    environment:
      MTA: "exim"
      MM_HOSTNAME: "mailman-core"
      SMTP_HOST: "exim"
      HYPERKITTY_API_KEY: "${HYPERKITTY_API_KEY}"
      DATABASE_URL: "postgres://${PG_USER}:${PG_PASS}@pg:5432/mailman"
      DATABASE_TYPE: "postgres"
      DATABASE_CLASS: "mailman.database.postgresql.PostgreSQLDatabase"

  mailman-web:
    image: quay.io/maxking/mailman-web:0.2
    volumes:
      - mm-web-data:/opt/mailman-web-data
    networks:
      - backend
    environment:
      UWSGI_STATIC_MAP: /static=/opt/mailman-web-data/static
      SERVE_FROM_DOMAIN: mailman.gtf.io
      HYPERKITTY_API_KEY: "${HYPERKITTY_API_KEY}"
      MAILMAN_ADMIN_USER: "${MAILMAN_ADMIN_USER}"
      MAILMAN_ADMIN_EMAIL: "${MAILMAN_ADMIN_EMAIL}"
      SECRET_KEY: "${MAILMAN_SECRET_KEY}"
      DATABASE_URL: "postgres://${PG_USER}:${PG_PASS}@pg:5432/mailman"
      SMTP_HOST: "exim"

  exim:
    build: ./exim
    networks:
      - backend
    volumes:
      # exim4 needs access to the mailman binaries apparently
      # https://mailman.readthedocs.io/en/release-3.0/src/mailman/docs/MTA.html
      - mm-core-data:/opt/mailman/core
    ports:
      - "25:25"

  jenkins:
    image: jenkins/jenkins:lts
    networks:
      - backend
    volumes:
      - jenkins-data:/var/jenkins_home

networks:
  backend:

volumes:
  db-data:
  mm-core-data:
  mm-web-data:
  jenkins-data:
